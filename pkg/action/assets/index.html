<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chronos Benchmark Results</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 24px max(24px, 5%);
            background-color: hsl(0 0% 100%);
            color: hsl(222.2 84% 4.9%);
            font-size: 14px;
            line-height: 1.5;
        }
        h1 {
            color: hsl(222.2 84% 4.9%);
            margin-bottom: 32px;
            text-align: center;
            font-weight: 600;
            font-size: 30px;
            letter-spacing: -0.025em;
        }
        .filter-section {
						display: flex;
						flex-direction: column;
						gap: 8px;

            background: hsl(0 0% 100%);
            padding: 24px;
            border: 1px solid hsl(214.3 31.8% 91.4%);
            border-radius: 8px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px 0 hsl(0 0% 0% / 0.1), 0 1px 2px -1px hsl(0 0% 0% / 0.1);
        }
				.filter-section > div {
					display: flex;
					gap: 8px;
					flex-wrap: wrap;
				}
        .filter-section label {
            display: block;
            font-weight: 500;
            font-size: 14px;
            color: hsl(222.2 84% 4.9%);
        }
        .filter-input {
						flex-grow: 1;
            max-width: 300px;
						width: 100%;
						height: 18px;
            padding: 8px 12px;
            border: 1px solid hsl(214.3 31.8% 91.4%);
            border-radius: 6px;
            background: hsl(0 0% 100%);
            font-size: 14px;
            color: hsl(222.2 84% 4.9%);
            transition: border-color 0.2s ease;
        }
        .filter-input:focus {
            outline: none;
            border-color: hsl(221.2 83.2% 53.3%);
            box-shadow: 0 0 0 2px hsl(221.2 83.2% 53.3% / 0.2);
        }
        .clear-button {
            padding: 8px 16px;
            background: hsl(0 0% 100%);
            color: hsl(222.2 84% 4.9%);
            border: 1px solid hsl(214.3 31.8% 91.4%);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .clear-button:hover {
            background: hsl(210 40% 98%);
            border-color: hsl(217.2 32.6% 17.5%);
        }
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(100%, 550px), 1fr));
            gap: 24px;
        }
        .chart-card {
            border: 1px solid hsl(214.3 31.8% 91.4%);
            border-radius: 8px;
            padding: 24px;
            background: hsl(0 0% 100%);
            box-shadow: 0 1px 3px 0 hsl(0 0% 0% / 0.1), 0 1px 2px -1px hsl(0 0% 0% / 0.1);
        }
        .chart-title {
            margin: 0 0 20px 0;
            color: hsl(222.2 84% 4.9%);
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -0.025em;
            border-bottom: 1px solid hsl(214.3 31.8% 91.4%);
            padding-bottom: 12px;
        }
        .unit-tab {
            background: hsl(0 0% 100%);
            border: 1px solid hsl(214.3 31.8% 91.4%);
            border-radius: 6px;
            padding: 8px 16px;
            margin-right: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            display: inline-block;
            color: hsl(222.2 84% 4.9%);
            transition: all 0.2s ease;
        }
        .unit-tab:hover {
            background: hsl(210 40% 98%);
            border-color: hsl(217.2 32.6% 17.5%);
        }
        .unit-tab.active {
            background: hsl(222.2 47.4% 11.2%);
            color: hsl(210 40% 98%);
            border-color: hsl(222.2 47.4% 11.2%);
        }
        .tab-container {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid hsl(214.3 31.8% 91.4%);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
        }
        .tabs-group {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
        }
        .buttons-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
        }
        .screenshot-button {
            background: hsl(0 0% 100%);
            border: 1px solid hsl(214.3 31.8% 91.4%);
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: hsl(222.2 84% 4.9%);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .screenshot-button:hover {
            background: hsl(210 40% 98%);
            border-color: hsl(217.2 32.6% 17.5%);
        }
        .compare-button {
            background: hsl(0 0% 100%);
            border: 1px solid hsl(214.3 31.8% 91.4%);
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: hsl(222.2 84% 4.9%);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .compare-button:hover {
            background: hsl(210 40% 98%);
            border-color: hsl(217.2 32.6% 17.5%);
        }
        .compare-button.active {
            background: hsl(221.2 83.2% 53.3%);
            color: hsl(0 0% 100%);
            border-color: hsl(221.2 83.2% 53.3%);
        }
        .comparison-info {
            margin-top: 12px;
            padding: 12px;
            background: hsl(210 40% 98%);
            border: 1px solid hsl(214.3 31.8% 91.4%);
            border-radius: 6px;
            font-size: 13px;
            display: none;
        }
        .chart-wrapper {
						display: flex;
						width: 100%;
            height: 350px;
        }
        .no-results {
            text-align: center;
            color: hsl(215.4 16.3% 46.9%);
            font-size: 14px;
            padding: 48px;
            background: hsl(0 0% 100%);
            border: 1px solid hsl(214.3 31.8% 91.4%);
            border-radius: 8px;
            box-shadow: 0 1px 3px 0 hsl(0 0% 0% / 0.1), 0 1px 2px -1px hsl(0 0% 0% / 0.1);
        }
        .loading {
            text-align: center;
            padding: 48px;
            font-size: 14px;
            color: hsl(215.4 16.3% 46.9%);
        }
    </style>
</head>
<body>
    <div>
        <div class="filter-section">
            <label for="benchmarkFilter">Filter by Benchmark Name:</label>
						<div>
							<input type="text" id="benchmarkFilter" class="filter-input" placeholder="Type to filter benchmarks...">
							<button id="clearFilter" class="clear-button">Clear</button>
						</div>
        </div>

        <div id="chartsContainer" class="charts-container">
            <div class="loading">Loading benchmark data...</div>
        </div>
    </div>

    <script>

        // Benchmark data will be injected here by the Go application
        window.BENCHMARK_DATA = {{.BenchmarkData}};

        class BenchmarkVisualizer {
            constructor() {
                this.data = [];
                this.filteredData = [];
                this.charts = new Map();
                this.comparisonState = new Map(); // Track comparison state per chart
                this.colors = [
                    'hsl(221.2 83.2% 53.3%)', // blue
                    'hsl(142.1 76.2% 36.3%)', // green
                    'hsl(346.8 77.2% 49.8%)', // red
                    'hsl(258.3 89.5% 66.3%)', // purple
                    'hsl(24.6 95% 53.1%)', // orange
                    'hsl(262.1 83.3% 57.8%)', // violet
                    'hsl(173.4 58.9% 39.1%)', // teal
                    'hsl(43.3 96.4% 56.3%)', // yellow
                    'hsl(197.4 71.4% 73.3%)', // sky
                    'hsl(20.5 90.2% 48.2%)' // amber
                ];
            }

            init() {
                this.loadData();
                this.setupEventListeners();
                this.filteredData = [...this.data];
                this.renderCharts();
            }

            loadData() {
                try {
                    this.data = window.BENCHMARK_DATA || [];
                } catch (error) {
                    console.error('Failed to load benchmark data:', error);
                    this.data = [];
                    document.getElementById('chartsContainer').innerHTML =
                        '<div class="no-results">Failed to load benchmark data.</div>';
                }
            }

            setupEventListeners() {
                const filterInput = document.getElementById('benchmarkFilter');
                const clearButton = document.getElementById('clearFilter');

                filterInput.addEventListener('input', (e) => {
                    this.filterBenchmarks(e.target.value);
                });

                clearButton.addEventListener('click', () => {
                    filterInput.value = '';
                    this.filterBenchmarks('');
                });

                window.addEventListener('resize', () => {
                    this.charts.forEach(chart => {
                        chart.resize();
                    });
                });
            }

            filterBenchmarks(query) {
                if (!query.trim()) {
                    this.filteredData = [...this.data];
                } else {
                    const lowerQuery = query.toLowerCase();
                    this.filteredData = this.data.filter(series =>
                        series.name.toLowerCase().includes(lowerQuery)
                    );
                }
                this.renderCharts();
            }

            renderCharts() {
                const container = document.getElementById('chartsContainer');
                container.innerHTML = '';
                this.charts.clear();

                if (this.filteredData.length === 0) {
                    if (this.data.length === 0) {
                        container.innerHTML = '<div class="no-results">No benchmark data available.</div>';
                    } else {
                        container.innerHTML = '<div class="no-results">No benchmarks found matching the filter.</div>';
                    }
                    return;
                }

                this.filteredData.forEach((series, index) => {
                    this.createBenchmarkChart(series, container, index);
                });
            }

            createBenchmarkChart(series, container, index) {
                const chartDiv = document.createElement('div');
                chartDiv.className = 'chart-card';

                const units = this.getUnitsForSeries(series);
                const tabsHtml = units.map((unit, tabIndex) =>
                    `<button class="unit-tab ${tabIndex === 0 ? 'active' : ''}" data-unit="${unit}">
                        ${this.formatUnitName(unit)}
                    </button>`
                ).join('');

                chartDiv.innerHTML = `
                    <h2 class="chart-title">${series.name}</h2>
                    <div class="tab-container">
                        <div class="tabs-group">
                            ${tabsHtml}
                        </div>
                        <div class="buttons-group">
                            <button class="screenshot-button" data-chart="${series.name}">
                                📷 Save PNG
                            </button>
                            <button class="compare-button" data-chart="${series.name}">
                                📊 Compare
                            </button>
                        </div>
                    </div>
                    <div class="comparison-info" id="comparison-${series.name}"></div>
                    <div class="chart-wrapper"></div>
                `;

                container.appendChild(chartDiv);

                // Use setTimeout to ensure DOM is fully rendered before initializing chart
                setTimeout(() => {
                    const chartWrapper = chartDiv.querySelector('.chart-wrapper');
                    const chart = echarts.init(chartWrapper);
                    this.charts.set(series.name, chart);

                    this.setupTabSwitching(chartDiv, series, chart, index);
                    this.renderChartForUnit(series, units[0], chart, index);
                }, 10);
            }

            getUnitsForSeries(series) {
                const units = new Set();
                series.measurements.forEach(measurement => {
                    measurement.metrics.forEach(metric => {
                        units.add(metric.unit);
                    });
                });
                return Array.from(units).sort();
            }

            formatUnitName(unit) {
                return unit;
            }

            getRepositoryUrl() {
                // Try to get repository URL from various sources
                // 1. Check if we're on GitHub Pages
                const hostname = window.location.hostname;
                if (hostname.endsWith('.github.io')) {
                    const parts = hostname.split('.');
                    if (parts.length >= 3) {
                        const username = parts[0];
                        const repoName = window.location.pathname.split('/')[1] || parts[1];
                        return `https://github.com/${username}/${repoName}`;
                    }
                }

                // 2. Check for common GitHub repository patterns in URL
                if (window.location.href.includes('github.com')) {
                    const match = window.location.href.match(/github\.com\/([^\/]+\/[^\/]+)/);
                    if (match) {
                        return `https://github.com/${match[1]}`;
                    }
                }

                // 3. Default fallback - you can customize this for your specific repository
                // For now, we'll try to construct from the page title or use a generic pattern
                return 'https://github.com/dkharms/chronos'; // Update this to your actual repository
            }

            setupTabSwitching(chartDiv, series, chart, index) {
                const tabs = chartDiv.querySelectorAll('.unit-tab');
                tabs.forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const unit = e.target.dataset.unit;

                        tabs.forEach(t => t.classList.remove('active'));
                        e.target.classList.add('active');

                        this.renderChartForUnit(series, unit, chart, index);
                    });
                });

                // Add screenshot functionality
                const screenshotButton = chartDiv.querySelector('.screenshot-button');
                screenshotButton.addEventListener('click', () => {
                    this.downloadChartScreenshot(chart, series.name);
                });

                // Add comparison functionality
                const compareButton = chartDiv.querySelector('.compare-button');
                compareButton.addEventListener('click', () => {
                    this.toggleComparisonMode(series.name, compareButton);
                });
            }

            downloadChartScreenshot(chart, chartName) {
                try {
                    const dataURL = chart.getDataURL({
                        type: 'png',
                        pixelRatio: 2,
                        backgroundColor: '#ffffff'
                    });

                    const link = document.createElement('a');
                    link.download = `${chartName.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_chart.png`;
                    link.href = dataURL;
                    link.click();
                } catch (error) {
                    console.error('Failed to download chart screenshot:', error);
                    alert('Failed to save screenshot. Please try again.');
                }
            }

            toggleComparisonMode(chartName, button) {
                const state = this.comparisonState.get(chartName) || { active: false, selectedPoints: [], currentUnit: null };

                if (state.active) {
                    // Exit comparison mode
                    this.exitComparisonMode(chartName, button);
                } else {
                    // Enter comparison mode
                    this.enterComparisonMode(chartName, button);
                }
            }

            enterComparisonMode(chartName, button) {
                const state = { active: true, selectedPoints: [], currentUnit: null };
                this.comparisonState.set(chartName, state);

                button.classList.add('active');
                button.textContent = '❌ Cancel Compare';

                const comparisonInfo = document.getElementById(`comparison-${chartName}`);
                comparisonInfo.style.display = 'block';
                comparisonInfo.innerHTML = '<strong>Comparison Mode:</strong> Click on two data points to compare them.';
            }

            exitComparisonMode(chartName, button) {
                this.comparisonState.delete(chartName);

                button.classList.remove('active');
                button.textContent = '📊 Compare';

                const comparisonInfo = document.getElementById(`comparison-${chartName}`);
                comparisonInfo.style.display = 'none';

                // Reset chart styling
                const chart = this.charts.get(chartName);
                if (chart) {
                    const option = chart.getOption();
                    option.series[0].markPoint = undefined;
                    chart.setOption(option);
                }
            }

            handleComparisonClick(chartName, params, unit, sortedData, sortedHashes) {
                const state = this.comparisonState.get(chartName);
                if (!state || !state.active) return false;

                state.currentUnit = unit;
                const pointData = {
                    index: params.dataIndex,
                    commit: params.name,
                    fullCommit: sortedHashes[params.dataIndex],
                    value: params.value[1]
                };

                if (state.selectedPoints.length === 0) {
                    // First point selected
                    state.selectedPoints.push(pointData);
                    this.updateComparisonDisplay(chartName, state, 'first');
                } else if (state.selectedPoints.length === 1) {
                    // Second point selected - show comparison
                    state.selectedPoints.push(pointData);
                    this.showComparison(chartName, state, unit);
                } else {
                    // Reset and select new first point
                    state.selectedPoints = [pointData];
                    this.updateComparisonDisplay(chartName, state, 'first');
                }

                this.highlightSelectedPoints(chartName, state, sortedData);
                return true; // Consumed the click
            }

            updateComparisonDisplay(chartName, state, mode) {
                const comparisonInfo = document.getElementById(`comparison-${chartName}`);
                if (mode === 'first') {
                    const point = state.selectedPoints[0];
                    comparisonInfo.innerHTML = `<strong>Point 1 selected:</strong> ${point.commit} (${point.value.toLocaleString()} ${state.currentUnit})<br/><em>Click another point to compare.</em>`;
                }
            }

            showComparison(chartName, state, unit) {
                const [point1, point2] = state.selectedPoints;
                const diff = point2.value - point1.value;
                const percentChange = ((diff) / point1.value * 100);
                const changeSign = diff > 0 ? '+' : '';

                const comparisonInfo = document.getElementById(`comparison-${chartName}`);
                comparisonInfo.innerHTML = `
                    <strong>Comparison Results:</strong><br/>
                    <strong>Point 1:</strong> ${point1.commit} → ${point1.value.toLocaleString()} ${unit}<br/>
                    <strong>Point 2:</strong> ${point2.commit} → ${point2.value.toLocaleString()} ${unit}<br/>
                    <strong>Difference:</strong> ${changeSign}${diff.toLocaleString()} ${unit} (${changeSign}${percentChange.toFixed(2)}%)
                `;
            }

            highlightSelectedPoints(chartName, state, sortedData) {
                const chart = this.charts.get(chartName);
                if (!chart) return;

                const markPoints = state.selectedPoints.map((point, index) => ({
                    coord: [point.index, point.value],
                    symbol: 'pin',
                    symbolSize: 30,
                    itemStyle: {
                        color: index === 0 ? '#3b82f6' : '#ef4444'
                    },
                    label: {
                        show: true,
                        position: 'top',
                        formatter: `Point ${index + 1}`,
                        color: '#000'
                    }
                }));

                const option = chart.getOption();
                option.series[0].markPoint = {
                    data: markPoints
                };
                chart.setOption(option);
            }

            renderChartForUnit(series, unit, chart, index) {
                const data = [];
                const commitHashes = [];

                series.measurements.forEach(measurement => {
                    const metric = measurement.metrics.find(m => m.unit === unit);
                    if (metric) {
                        data.push([measurement.commit_hash.substring(0, 8), metric.value]);
                        commitHashes.push(measurement.commit_hash);
                    }
                });

                // Keep original order - no sorting needed
                const sortedData = data;
                const sortedHashes = commitHashes;

                const color = this.colors[index % this.colors.length];
                const option = {
                    animation: true,
                    tooltip: {
                        trigger: 'item',
                        backgroundColor: 'hsl(0 0% 100%)',
                        borderColor: 'hsl(214.3 31.8% 91.4%)',
                        borderWidth: 1,
                        textStyle: {
                            color: 'hsl(222.2 84% 4.9%)',
                            fontSize: 12
                        },
                        formatter: (params) => {
                            const currentValue = params.value[1];
                            const dataIndex = params.dataIndex;

                            let tooltip = `Commit: ${params.name}<br/>Value: ${currentValue.toLocaleString()} ${unit}`;

                            // Calculate percentage change from previous point
                            if (dataIndex > 0) {
                                const previousValue = sortedData[dataIndex - 1][1];
                                const percentChange = ((currentValue - previousValue) / previousValue * 100);
                                const changeSign = percentChange > 0 ? '+' : '';
                                tooltip += `<br/><span style="font-weight: 500;">
                                    ${changeSign}${percentChange.toFixed(2)}% from previous
                                </span>`;
                            }

                            return tooltip;
                        }
                    },
                    xAxis: {
                        type: 'category',
                        axisLine: {
                            lineStyle: {
                                color: 'hsl(214.3 31.8% 91.4%)'
                            }
                        },
                        axisTick: {
                            lineStyle: {
                                color: 'hsl(214.3 31.8% 91.4%)'
                            }
                        },
                        axisLabel: {
                            rotate: 45,
                            fontSize: 11,
                            color: 'hsl(215.4 16.3% 46.9%)'
                        }
                    },
                    yAxis: {
                        type: 'value',
                        scale: true,
                        axisLine: {
                            lineStyle: {
                                color: 'hsl(214.3 31.8% 91.4%)'
                            }
                        },
                        axisTick: {
                            lineStyle: {
                                color: 'hsl(214.3 31.8% 91.4%)'
                            }
                        },
                        axisLabel: {
                            color: 'hsl(215.4 16.3% 46.9%)',
                            fontSize: 11,
                            formatter: (value) => {
                                if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
                                if (value >= 1000) return (value / 1000).toFixed(1) + 'K';
								return value.toLocaleString();
                            }
                        },
                        splitLine: {
                            lineStyle: {
                                color: 'hsl(214.3 31.8% 91.4%)',
                                type: 'dashed'
                            }
                        },
						name: unit,
						nameLocation: 'middle',
						nameTextStyle: {
							color: 'hsl(215.4 16.3% 46.9%)',
						},
						nameGap: 40,
					},
                    series: [{
                        name: series.name,
                        type: 'line',
                        data: sortedData,
                        symbol: 'circle',
                        symbolSize: 7,
                        smooth: true,
                        lineStyle: {
                            width: 2,
                            color: color
                        },
                        itemStyle: {
                            color: color
                        },
                        emphasis: {
                            disabled: true
                        },
                        blur: {
                            disabled: true
                        },
                        select: {
                            disabled: true
                        },
                        markLine: undefined
                    }]
                }

                chart.setOption(option, true);

                // Add click event to open commit URL or handle comparison
                chart.off('click'); // Remove any existing click handlers
                chart.on('click', (params) => {
                    if (params.componentType === 'series' && params.seriesType === 'line') {
                        // Check if in comparison mode first
                        const comparisonHandled = this.handleComparisonClick(series.name, params, unit, sortedData, sortedHashes);

                        if (!comparisonHandled) {
                            // Normal click - open commit URL
                            const commitHash = sortedHashes[params.dataIndex];
                            const repoUrl = this.getRepositoryUrl();
                            if (repoUrl && commitHash) {
                                const commitUrl = `${repoUrl}/commit/${commitHash}`;
                                window.open(commitUrl, '_blank');
                            }
                        }
                    }
                });
            }
        }

        // Wait for both DOM and ECharts to be ready
        function initializeWhenReady() {
            if (typeof echarts !== 'undefined' && document.readyState === 'complete') {
                const visualizer = new BenchmarkVisualizer();
                visualizer.init();
            } else {
                setTimeout(initializeWhenReady, 50);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeWhenReady);
        } else {
            initializeWhenReady();
        }
    </script>
</body>
</html>
